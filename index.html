<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypto Exchange</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #000000;
            --primary-card: #131313;
            --secondary-card: #1c1c1c;
            --border-color: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #8E8E93;
            --accent-blue: #0A84FF;
            --accent-green: #30D158;
            --accent-red: #FF453A;
            --accent-yellow: #FFD60A;
            --accent-purple: #BF5AF2;
        }
        body, input, textarea, button {
            font-family: 'Inter', sans-serif;
            color: var(--tg-theme-text-color, var(--text-primary));
        }
        body {
            background-color: var(--tg-theme-bg-color, var(--bg-color));
            overscroll-behavior: none;
        }
        .btn-primary {
            background-color: var(--tg-theme-button-color, var(--accent-blue));
            color: var(--tg-theme-button-text-color, var(--text-primary));
        }
        html, body { height: 100%; width: 100%; overflow: hidden; }
        #app { height: 100%; display: flex; flex-direction: column; opacity: 0; transition: opacity 0.3s ease-in; }
        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 1.25rem; padding-bottom: 6rem;
            overflow-y: auto; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform: translateY(10px);
            z-index: 1;
        }
        .page.active { opacity: 1; visibility: visible; transform: translateY(0); z-index: 2; }
        .glass-card {
            background: rgba(28, 28, 28, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border-color);
            border-radius: 1.25rem;
        }
        .amount-input {
            width: 100%; background: transparent; border: none; outline: none;
            color: var(--text-primary); font-size: 2.25rem; line-height: 2.5rem; font-weight: 700;
            padding: 0;
            -moz-appearance: textfield;
        }
        .amount-input::placeholder { color: var(--text-secondary); }
        .amount-input::-webkit-outer-spin-button, .amount-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .coin-pill {
            display: flex; align-items: center; gap: 0.5rem;
            background-color: var(--secondary-card); padding: 0.5rem 1rem 0.5rem 0.5rem;
            border-radius: 9999px; cursor: pointer; transition: background-color 0.2s;
        }
        .coin-pill:hover { background-color: #2c2c2e; }
        .coin-pill img { width: 2rem; height: 2rem; border-radius: 50%; }
        .swap-icon {
            width: 3rem; height: 3rem; border-radius: 50%;
            background-color: var(--secondary-card); border: 4px solid var(--bg-color);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.3s, background-color 0.2s;
        }
        .swap-icon:hover { background-color: #2c2c2e; }
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(22, 22, 22, 0.8);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid var(--border-color);
            display: flex; justify-content: space-around;
            padding: 0.5rem 0; padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
            z-index: 100;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 0.25rem;
            color: var(--text-secondary); padding: 0.5rem 1rem; transition: color 0.2s;
        }
        .nav-item.active { color: var(--accent-blue); }
        #background-animation {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; overflow: hidden; background: #050211;
        }
        .gradient {
            position: absolute; width: 50vmax; height: 50vmax;
            border-radius: 50%; filter: blur(100px); opacity: 0.2;
            animation: drift 20s infinite alternate ease-in-out;
        }
        .g1 { background: #0A84FF; top: -10%; left: -10%; animation-duration: 22s; }
        .g2 { background: #BF5AF2; bottom: -15%; right: -15%; animation-duration: 25s; }
        .g3 { background: #30D158; bottom: 30%; left: -5%; animation-duration: 18s; }
        @keyframes drift {
            from { transform: rotate(0deg) translateX(20px); }
            to { transform: rotate(360deg) translateX(-20px); }
        }
        .support-topic {
            background-color: var(--secondary-card);
            border: 1px solid var(--border-color);
            transition: border-color 0.2s, background-color 0.2s;
        }
        .support-topic.selected {
            border-color: var(--accent-blue);
            background-color: rgba(10, 132, 255, 0.1);
        }
        #qrcode-container {
             background: white;
             padding: 1rem;
             border-radius: 1rem;
             display: inline-block;
        }
        #qrcode-container canvas {
            display: block;
        }
        .avatar-placeholder {
            background-color: var(--accent-purple);
            color: white;
        }
        .modal {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal.visible {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body class="antialiased">

    <div id="loader-overlay" class="fixed inset-0 bg-black flex items-center justify-center z-[999] transition-opacity duration-300">
        <svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <div id="background-animation">
        <div class="gradient g1"></div>
        <div class="gradient g2"></div>
        <div class="gradient g3"></div>
    </div>

    <div id="app">
        <!-- All pages are defined here -->
        <div id="page-exchange" class="page">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-3xl font-bold">Обмен</h1>
                <div id="profile-icon-container-exchange" class="cursor-pointer"></div>
            </div>
            <div class="glass-card p-4 space-y-4">
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-text-secondary">Отправляете</span>
                        <span class="text-xs text-text-secondary">Баланс: 1,420.69 USDT</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <input type="number" id="from-amount" class="amount-input" placeholder="0" inputmode="decimal">
                        <div class="coin-pill">
                            <img src="https://s2.coinmarketcap.com/static/img/coins/64x64/825.png" alt="USDT">
                            <span class="font-bold text-lg">USDT</span>
                        </div>
                    </div>
                </div>
                <div class="relative flex justify-center items-center">
                    <hr class="w-full border-border-color">
                    <div id="swap-button" class="swap-icon absolute">
                        <svg class="w-6 h-6 text-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 12l-4-4m4 4l4-4m6 8v-12m0 12l-4-4m4 4l4-4"/></svg>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-text-secondary">Получаете</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <input type="number" id="to-amount" class="amount-input text-text-secondary" placeholder="0" readonly>
                        <div id="to-coin-selector" class="coin-pill">
                            <img id="to-coin-img" src="https://s2.coinmarketcap.com/static/img/coins/64x64/1958.png" alt="TRX">
                            <span id="to-coin-symbol" class="font-bold text-lg">TRX</span>
                            <svg class="w-5 h-5 text-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </div>
                    </div>
                </div>
            </div>
            <div id="rate-info" class="text-center text-sm text-gray-300 mt-6 h-5 font-medium"></div>
            <div id="promo-info" class="text-center text-sm text-green-400 mt-2 h-5 font-semibold"></div>
            <div class="absolute bottom-24 left-5 right-5 z-20">
                <button id="continue-btn" class="w-full btn-primary font-bold py-4 rounded-xl text-lg transition-all duration-300 transform scale-95 opacity-50" disabled>
                    Продолжить
                </button>
            </div>
        </div>

        <div id="page-news" class="page">
            <h1 class="text-3xl font-bold mb-6">Новости</h1>
            <div id="news-container" class="space-y-4">
                <div class="text-center py-10 text-text-secondary">Загрузка новостей...</div>
            </div>
        </div>

        <div id="page-support" class="page">
             <h1 class="text-3xl font-bold mb-6">Поддержка</h1>
             <div class="space-y-6">
                <div>
                    <label class="font-medium text-text-secondary mb-2 block">Тема обращения</label>
                    <div id="support-topics-container" class="grid grid-cols-2 gap-3"></div>
                </div>
                 <div>
                    <label class="font-medium text-text-secondary mb-2 block">Ваше сообщение</label>
                    <textarea id="support-message" class="w-full h-32 p-3 bg-secondary-card rounded-lg border border-border-color focus:border-accent-blue focus:outline-none transition" placeholder="Подробно опишите вашу проблему..."></textarea>
                </div>
                <button id="send-support-ticket-btn" class="w-full btn-primary font-bold py-4 rounded-xl text-lg opacity-50" disabled>
                    Отправить
                </button>
             </div>
        </div>
        
        <div id="page-profile" class="page">
            <div class="flex items-center space-x-4 mb-8">
                 <div id="profile-avatar" class="w-20 h-20 rounded-full flex items-center justify-center text-3xl font-bold"></div>
                 <div>
                    <h1 id="profile-name" class="text-2xl font-bold">Загрузка...</h1>
                    <p id="profile-username" class="text-text-secondary">@username</p>
                 </div>
            </div>
            <div class="space-y-4">
                <h2 class="text-xl font-bold">Статистика</h2>
                <div class="glass-card p-4">
                    <div class="flex justify-between items-center">
                        <span class="font-medium">Успешных обменов</span>
                        <span id="exchanges-completed" class="font-bold text-lg">0</span>
                    </div>
                     <hr class="border-border-color my-3">
                     <div class="flex justify-between items-center">
                        <span class="font-medium">Акционных обменов осталось</span>
                        <span id="promo-exchanges-left" class="font-bold text-lg text-green-400">10</span>
                    </div>
                </div>
            </div>
             <div class="space-y-4 mt-8">
                <h2 class="text-xl font-bold">Действия</h2>
                <div class="glass-card p-4">
                     <button id="clear-cache-btn" class="w-full text-left font-medium text-accent-blue py-2">Очистить кэш приложения</button>
                </div>
            </div>
        </div>
        
        <!-- MODALS -->
        <div id="modal-confirm" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-end justify-center z-50">
             <div id="modal-confirm-content" class="w-full glass-card p-5 pb-8 rounded-t-3xl transform translate-y-full transition-transform duration-300">
                 <div class="w-12 h-1.5 bg-gray-600 rounded-full mx-auto mb-4"></div>
                 <h2 class="text-xl font-bold text-center mb-6">Подтверждение обмена</h2>
                 <div class="space-y-3">
                     <div class="flex justify-between items-center text-lg"><span class="text-text-secondary">Отдаете</span><span id="confirm-from-amount" class="font-bold"></span></div>
                     <div class="flex justify-between items-center text-lg"><span class="text-text-secondary">Получаете ≈</span><span id="confirm-to-amount" class="font-bold text-green-400"></span></div>
                 </div>
                 <button id="confirm-exchange-btn" class="mt-8 w-full btn-primary font-bold py-4 rounded-xl text-lg">Подтвердить</button>
             </div>
        </div>
        
        <div id="modal-payment" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-5 z-50">
             <div class="w-full max-w-sm glass-card p-6 text-center">
                 <h2 class="text-xl font-bold mb-2">Оплатите заявку</h2>
                 <p class="text-text-secondary mb-4">Отправьте точную сумму на кошелек ниже в течение <span id="payment-timer">15:00</span></p>
                 <div class="my-6">
                    <p class="text-3xl font-bold" id="payment-amount"></p>
                    <p class="text-sm text-text-secondary">USDT (TRC-20)</p>
                 </div>
                 <div id="qrcode-container" class="mx-auto my-6"></div>
                 <div class="w-full bg-secondary-card p-3 rounded-lg break-all text-xs text-center mb-6" id="payment-wallet"></div>
                 <button id="paid-btn" class="w-full btn-primary font-bold py-4 rounded-xl text-lg">Я оплатил</button>
             </div>
        </div>

        <div id="modal-blocked" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-5 z-50 text-center">
             <div class="w-full max-w-sm">
                <h2 class="text-2xl font-bold mb-4 text-accent-red">Доступ ограничен</h2>
                <p class="text-text-secondary mb-8">Ваш аккаунт был заблокирован. Пожалуйста, свяжитесь с поддержкой для выяснения причин.</p>
                <button id="contact-support-blocked-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl text-lg">Написать в поддержку</button>
             </div>
        </div>


        <!-- Bottom Navigation Bar -->
        <div class="bottom-nav">
            <div class="nav-item active" data-page="exchange">
                <svg class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                <span class="text-xs font-medium">Обмен</span>
            </div>
            <div class="nav-item" data-page="news">
                <svg class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4 12H9m3 0a3 3 0 01-3-3V9a3 3 0 013-3h.01M9 12h3" /></svg>
                <span class="text-xs font-medium">Новости</span>
            </div>
            <div class="nav-item" data-page="support">
                <svg class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                <span class="text-xs font-medium">Поддержка</span>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIGURATION ---
    const BACKEND_URL = 'https://ramzyn1.pythonanywhere.com/';
    const COINGECKO_API_URL = 'https://api.coingecko.com/api/v3';
    const PROMO_BONUS_PERCENT = 7.23;
    const TOTAL_PROMO_EXCHANGES = 10;
    const MIN_EXCHANGE_AMOUNT = 20;
    const SUPPORT_TOPICS = [
        "Проблема с обменом", "Вопрос по курсу", "Не пришла валюта",
        "Предложения", "Блокировка", "Другое"
    ];
    const COINS = {
        trx: { name: 'TRON', symbol: 'TRX', id: 'tron', icon: 'https://s2.coinmarketcap.com/static/img/coins/64x64/1958.png' },
        sol: { name: 'Solana', symbol: 'SOL', id: 'solana', icon: 'https://s2.coinmarketcap.com/static/img/coins/64x64/5426.png' },
        bnb: { name: 'BNB', symbol: 'BNB', id: 'binancecoin', icon: 'https://s2.coinmarketcap.com/static/img/coins/64x64/1839.png' }
    };

    // --- STATE MANAGEMENT ---
    const state = {
        currentPage: 'exchange',
        rates: {},
        selectedCoin: 'trx',
        fromAmount: '',
        toAmount: '',
        wallet: '',
        isBlocked: false,
        timerInterval: null,
        selectedSupportTopic: null,
        tg: window.Telegram.WebApp,
    };
    
    // --- DOM ELEMENTS ---
    const DOMElements = {
        app: document.getElementById('app'),
        loaderOverlay: document.getElementById('loader-overlay'),
        pages: document.querySelectorAll('.page'),
        navItems: document.querySelectorAll('.nav-item'),
        fromAmountInput: document.getElementById('from-amount'),
        toAmountInput: document.getElementById('to-amount'),
        toCoinImg: document.getElementById('to-coin-img'),
        toCoinSymbol: document.getElementById('to-coin-symbol'),
        rateInfo: document.getElementById('rate-info'),
        promoInfo: document.getElementById('promo-info'),
        continueBtn: document.getElementById('continue-btn'),
        modalConfirm: document.getElementById('modal-confirm'),
        modalConfirmContent: document.getElementById('modal-confirm-content'),
        confirmFromAmount: document.getElementById('confirm-from-amount'),
        confirmToAmount: document.getElementById('confirm-to-amount'),
        confirmExchangeBtn: document.getElementById('confirm-exchange-btn'),
        modalPayment: document.getElementById('modal-payment'),
        paymentAmount: document.getElementById('payment-amount'),
        paymentWallet: document.getElementById('payment-wallet'),
        paymentTimer: document.getElementById('payment-timer'),
        qrcodeContainer: document.getElementById('qrcode-container'),
        paidBtn: document.getElementById('paid-btn'),
        modalBlocked: document.getElementById('modal-blocked'),
        profileName: document.getElementById('profile-name'),
        profileUsername: document.getElementById('profile-username'),
        profileAvatar: document.getElementById('profile-avatar'),
        exchangesCompleted: document.getElementById('exchanges-completed'),
        promoExchangesLeft: document.getElementById('promo-exchanges-left'),
        supportTopicsContainer: document.getElementById('support-topics-container'),
        supportMessage: document.getElementById('support-message'),
        sendSupportTicketBtn: document.getElementById('send-support-ticket-btn'),
        newsContainer: document.getElementById('news-container'),
        profileIconContainerExchange: document.getElementById('profile-icon-container-exchange'),
    };

    // --- LOCAL STORAGE ---
    const LocalStorage = {
        getStats: () => ({
            completed: parseInt(localStorage.getItem('exchangesCompleted') || '0'),
            promoLeft: parseInt(localStorage.getItem('promoExchangesLeft') ?? TOTAL_PROMO_EXCHANGES)
        }),
        saveStats: (stats) => {
            localStorage.setItem('exchangesCompleted', stats.completed);
            localStorage.setItem('promoExchangesLeft', stats.promoLeft);
        },
        clear: () => localStorage.clear()
    };
    
    // --- UI FUNCTIONS ---
    const UI = {
        navigateTo: (pageId) => {
            state.currentPage = pageId;
            DOMElements.pages.forEach(p => p.classList.toggle('active', p.id === `page-${pageId}`));
            DOMElements.navItems.forEach(item => item.classList.toggle('active', item.dataset.page === pageId));
            
            if (pageId === 'news' && DOMElements.newsContainer.children.length <= 1) App.fetchNews();
            if (pageId === 'profile') UI.updateProfileStats();
            if (pageId === 'support' && DOMElements.supportTopicsContainer.children.length === 0) UI.renderSupportTopics();
        },

        showModal: (modal, show = true) => {
            modal.classList.toggle('visible', show);
            if (modal.id === 'modal-confirm') {
                modal.querySelector('#modal-confirm-content').classList.toggle('translate-y-full', !show);
            }
        },

        updateExchangeButton: () => {
            const amount = parseFloat(state.fromAmount);
            const isValid = amount >= MIN_EXCHANGE_AMOUNT;
            DOMElements.continueBtn.disabled = !isValid;
            DOMElements.continueBtn.classList.toggle('opacity-50', !isValid);
            DOMElements.continueBtn.classList.toggle('scale-95', !isValid);
        },

        updateProfileUI: () => {
            const user = state.tg.initDataUnsafe?.user;
            if (user) {
                DOMElements.profileName.textContent = `${user.first_name || ''} ${user.last_name || ''}`.trim();
                DOMElements.profileUsername.textContent = user.username ? `@${user.username}` : 'ID: ' + user.id;

                const initials = ((user.first_name?.[0] || '') + (user.last_name?.[0] || '')).toUpperCase();
                
                const profileIconHTML = `<div class="w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold avatar-placeholder">${initials}</div>`;
                DOMElements.profileAvatar.innerHTML = profileIconHTML;
                DOMElements.profileIconContainerExchange.innerHTML = profileIconHTML.replace('w-20 h-20 text-3xl', 'w-10 h-10 text-lg');

                if(user.photo_url) {
                    const img = new Image();
                    img.src = user.photo_url;
                    img.onload = () => {
                         const photoHTML = `<img src="${user.photo_url}" class="w-20 h-20 rounded-full object-cover">`;
                         DOMElements.profileAvatar.innerHTML = photoHTML;
                         DOMElements.profileIconContainerExchange.innerHTML = photoHTML.replace('w-20 h-20', 'w-10 h-10');
                    };
                }
            } else {
                 DOMElements.profileName.textContent = 'Гость';
                 DOMElements.profileUsername.textContent = 'Анонимный пользователь';
            }
            UI.updateProfileStats();
        },

        updateProfileStats: () => {
            const stats = LocalStorage.getStats();
            DOMElements.exchangesCompleted.textContent = stats.completed;
            DOMElements.promoExchangesLeft.textContent = stats.promoLeft;
        },

        renderSupportTopics: () => {
            DOMElements.supportTopicsContainer.innerHTML = SUPPORT_TOPICS.map(topic => 
                `<button class="support-topic p-3 rounded-lg text-center font-medium" data-topic="${topic}">${topic}</button>`
            ).join('');
        },

        updateSupportButton: () => {
            const isValid = state.selectedSupportTopic && DOMElements.supportMessage.value.trim().length > 10;
            DOMElements.sendSupportTicketBtn.disabled = !isValid;
            DOMElements.sendSupportTicketBtn.classList.toggle('opacity-50', !isValid);
        },

        startTimer: () => {
            let duration = 15 * 60;
            if (state.timerInterval) clearInterval(state.timerInterval);
            
            state.timerInterval = setInterval(() => {
                const minutes = Math.floor(duration / 60).toString().padStart(2, '0');
                const seconds = (duration % 60).toString().padStart(2, '0');
                DOMElements.paymentTimer.textContent = `${minutes}:${seconds}`;

                if (--duration < 0) {
                    clearInterval(state.timerInterval);
                    UI.showModal(DOMElements.modalPayment, false);
                    App.showNotification('error', 'Время вышло! Заявка отменена.');
                }
            }, 1000);
        },
        
        showNotification: (type, text, duration = 3000) => {
            state.tg.HapticFeedback.notificationOccurred(type);
            const notif = document.createElement('div');
            notif.className = `fixed top-5 left-1/2 -translate-x-1/2 p-3 rounded-lg text-white font-semibold z-50 text-sm shadow-lg ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            notif.textContent = text;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), duration);
        }
    };

    // --- API & LOGIC ---
    const App = {
        init: async () => {
            state.tg.ready();
            state.tg.expand();
            state.tg.setHeaderColor('#000000');
            state.tg.setBackgroundColor('#000000');
            
            await App.fetchConfig();
            
            DOMElements.loaderOverlay.classList.add('opacity-0', 'pointer-events-none');

            if (state.isBlocked) {
                UI.showModal(DOMElements.modalBlocked, true);
            } else {
                DOMElements.app.classList.add('opacity-100');
                UI.navigateTo('exchange');
                UI.updateProfileUI();
                await App.fetchRates();
                App.bindEvents();
            }
        },

        fetchConfig: async () => {
            try {
                const userId = state.tg.initDataUnsafe?.user?.id || '0';
                const response = await fetch(`${BACKEND_URL}/api/get_config?userId=${userId}`);
                if (!response.ok) throw new Error('Network error');
                const data = await response.json();
                state.wallet = data.wallet;
                state.isBlocked = data.isBlocked;
            } catch (error) {
                console.error('Failed to fetch config:', error);
                App.showNotification('error', 'Ошибка загрузки конфигурации');
            }
        },

        fetchRates: async () => {
            try {
                const coinIds = Object.values(COINS).map(c => c.id).join(',');
                const response = await fetch(`${COINGECKO_API_URL}/simple/price?ids=${coinIds}&vs_currencies=usd`);
                const data = await response.json();
                Object.keys(COINS).forEach(key => {
                    state.rates[key] = data[COINS[key].id].usd;
                });
                App.calculateExchange();
            } catch (error) {
                console.error('Failed to fetch rates:', error);
                DOMElements.rateInfo.textContent = 'Ошибка загрузки курса';
            }
        },
        
        fetchNews: async () => {
            try {
                const response = await fetch(`${COINGECKO_API_URL}/news`);
                const { data } = await response.json();
                DOMElements.newsContainer.innerHTML = data.slice(0, 10).map(article => `
                    <a href="${article.url}" target="_blank" class="block glass-card p-4 hover:bg-secondary-card transition">
                        <div class="flex items-start space-x-4">
                            <img src="${article.thumb_2x}" class="w-16 h-16 rounded-lg object-cover">
                            <div>
                                <h3 class="font-bold mb-1 leading-tight">${article.title}</h3>
                                <p class="text-xs text-text-secondary">${article.news_site} &bull; ${new Date(article.updated_at).toLocaleDateString()}</p>
                            </div>
                        </div>
                    </a>
                `).join('');
            } catch (error) {
                console.error('Failed to fetch news:', error);
                DOMElements.newsContainer.innerHTML = `<div class="text-center py-10 text-text-secondary">Не удалось загрузить новости.</div>`;
            }
        },

        calculateExchange: () => {
            const amount = parseFloat(state.fromAmount);
            const rate = state.rates[state.selectedCoin];
            if (!amount || !rate) {
                DOMElements.toAmountInput.value = '';
                DOMElements.rateInfo.textContent = '';
                DOMElements.promoInfo.textContent = '';
                return;
            }

            let receiveAmount = amount / rate;
            const stats = LocalStorage.getStats();
            const isPromoActive = stats.promoLeft > 0;

            if (isPromoActive) {
                receiveAmount *= (1 + PROMO_BONUS_PERCENT / 100);
            }

            state.toAmount = receiveAmount.toFixed(6);
            DOMElements.toAmountInput.value = state.toAmount;

            const displayRate = (1 / rate).toFixed(4);
            DOMElements.rateInfo.textContent = `1 USDT ≈ ${displayRate} ${COINS[state.selectedCoin].symbol}`;
            DOMElements.promoInfo.textContent = isPromoActive ? `Бонус +${PROMO_BONUS_PERCENT}% активен!` : '';
        },
        
        sendSupportTicket: async () => {
            try {
                const user = state.tg.initDataUnsafe?.user;
                const response = await fetch(`${BACKEND_URL}/api/support`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: user?.id,
                        username: user?.username,
                        topic: state.selectedSupportTopic,
                        message: DOMElements.supportMessage.value.trim()
                    })
                });
                if (!response.ok) throw new Error('Server error');
                
                App.showNotification('success', 'Обращение успешно отправлено!');
                UI.navigateTo('exchange');
                DOMElements.supportMessage.value = '';
                state.selectedSupportTopic = null;
                document.querySelectorAll('.support-topic.selected').forEach(el => el.classList.remove('selected'));
                UI.updateSupportButton();
            } catch (error) {
                console.error('Failed to send ticket:', error);
                App.showNotification('error', 'Ошибка отправки. Попробуйте позже.');
            }
        },

        bindEvents: () => {
            DOMElements.navItems.forEach(item => {
                item.addEventListener('click', () => UI.navigateTo(item.dataset.page));
            });

            DOMElements.fromAmountInput.addEventListener('input', (e) => {
                state.fromAmount = e.target.value;
                App.calculateExchange();
                UI.updateExchangeButton();
            });

            DOMElements.continueBtn.addEventListener('click', () => {
                state.tg.HapticFeedback.impactOccurred('light');
                DOMElements.confirmFromAmount.textContent = `${state.fromAmount} USDT`;
                DOMElements.confirmToAmount.textContent = `${state.toAmount} ${COINS[state.selectedCoin].symbol}`;
                UI.showModal(DOMElements.modalConfirm, true);
            });
            
            DOMElements.modalConfirm.addEventListener('click', (e) => {
                if (e.target === DOMElements.modalConfirm) UI.showModal(DOMElements.modalConfirm, false);
            });

            DOMElements.confirmExchangeBtn.addEventListener('click', () => {
                UI.showModal(DOMElements.modalConfirm, false);
                DOMElements.paymentAmount.textContent = `${state.fromAmount} USDT`;
                DOMElements.paymentWallet.textContent = state.wallet;
                DOMElements.qrcodeContainer.innerHTML = ''; // Clear previous QR
                new QRCode(DOMElements.qrcodeContainer, {
                    text: state.wallet,
                    width: 160,
                    height: 160,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                UI.showModal(DOMElements.modalPayment, true);
                UI.startTimer();
            });

            DOMElements.paidBtn.addEventListener('click', () => {
                const stats = LocalStorage.getStats();
                stats.completed += 1;
                if (stats.promoLeft > 0) {
                    stats.promoLeft -= 1;
                }
                LocalStorage.saveStats(stats);
                UI.updateProfileStats();
                
                UI.showModal(DOMElements.modalPayment, false);
                clearInterval(state.timerInterval);
                
                App.showNotification('success', 'Оплата подтверждена! Ожидайте поступления.');
                
                DOMElements.fromAmountInput.value = '';
                state.fromAmount = '';
                App.calculateExchange();
                UI.updateExchangeButton();
            });

            DOMElements.supportTopicsContainer.addEventListener('click', (e) => {
                const target = e.target.closest('.support-topic');
                if (target) {
                    state.tg.HapticFeedback.selectionChanged();
                    document.querySelectorAll('.support-topic').forEach(el => el.classList.remove('selected'));
                    target.classList.add('selected');
                    state.selectedSupportTopic = target.dataset.topic;
                    UI.updateSupportButton();
                }
            });

            DOMElements.supportMessage.addEventListener('input', UI.updateSupportButton);
            DOMElements.sendSupportTicketBtn.addEventListener('click', App.sendSupportTicket);

            document.getElementById('clear-cache-btn').addEventListener('click', () => {
                 LocalStorage.clear();
                 UI.updateProfileStats();
                 App.showNotification('success', 'Кэш и статистика очищены!');
            });
            
            document.getElementById('contact-support-blocked-btn').addEventListener('click', () => {
                UI.showModal(DOMElements.modalBlocked, false);
                UI.navigateTo('support');
            });

            DOMElements.profileIconContainerExchange.addEventListener('click', () => UI.navigateTo('profile'));
        }
    };

    App.init();
});
</script>
</body>
</html>

